
{
  "entities": {
    "Patient": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Patient",
      "type": "object",
      "description": "Represents a patient in the clinic management system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the patient."
        },
        "firstName": {
          "type": "string",
          "description": "Patient's first name."
        },
        "lastName": {
          "type": "string",
          "description": "Patient's last name."
        },
        "dateOfBirth": {
          "type": "string",
          "description": "Patient's date of birth.",
          "format": "date-time"
        },
        "gender": {
          "type": "string",
          "description": "Patient's gender."
        },
        "contactNumber": {
          "type": "string",
          "description": "Patient's contact phone number."
        },
        "email": {
          "type": "string",
          "description": "Patient's email address.",
          "format": "email"
        },
        "address": {
          "type": "string",
          "description": "Patient's address."
        },
        "medicalHistory": {
          "type": "string",
          "description": "A summary of the patient's medical history."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "dateOfBirth",
        "gender",
        "contactNumber",
        "email",
        "address"
      ]
    },
    "Appointment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Appointment",
      "type": "object",
      "description": "Represents an appointment scheduled in the clinic.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the appointment."
        },
        "patientId": {
          "type": "string",
          "description": "Reference to the Patient. (Relationship: Patient 1:N Appointment)"
        },
        "doctorId": {
          "type": "string",
          "description": "Reference to the Doctor. (Relationship: Doctor 1:N Appointment)"
        },
        "appointmentDateTime": {
          "type": "string",
          "description": "Date and time of the appointment.",
          "format": "date-time"
        },
        "reasonForVisit": {
          "type": "string",
          "description": "Reason for the patient's visit."
        },
        "status": {
          "type": "string",
          "description": "Status of the appointment (e.g., scheduled, completed, cancelled)."
        }
      },
      "required": [
        "id",
        "patientId",
        "doctorId",
        "appointmentDateTime",
        "reasonForVisit",
        "status"
      ]
    },
    "Doctor": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Doctor",
      "type": "object",
      "description": "Represents a doctor in the clinic.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the doctor."
        },
        "firstName": {
          "type": "string",
          "description": "Doctor's first name."
        },
        "lastName": {
          "type": "string",
          "description": "Doctor's last name."
        },
        "specialization": {
          "type": "string",
          "description": "Doctor's area of specialization."
        },
        "contactNumber": {
          "type": "string",
          "description": "Doctor's contact phone number."
        },
        "email": {
          "type": "string",
          "description": "Doctor's email address.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "specialization",
        "contactNumber",
        "email"
      ]
    },
    "Consultation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Consultation",
      "type": "object",
      "description": "Represents a consultation record between a doctor and a patient.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the consultation."
        },
        "patientId": {
          "type": "string",
          "description": "Reference to the Patient. (Relationship: Patient 1:N Consultation)"
        },
        "doctorId": {
          "type": "string",
          "description": "Reference to the Doctor. (Relationship: Doctor 1:N Consultation)"
        },
        "appointmentId": {
          "type": "string",
          "description": "Reference to the Appointment. (Relationship: Appointment 1:1 Consultation)"
        },
        "consultationDateTime": {
          "type": "string",
          "description": "Date and time of the consultation.",
          "format": "date-time"
        },
        "notes": {
          "type": "string",
          "description": "Detailed notes from the consultation."
        },
        "symptoms": {
            "type": "string",
            "description": "Patient's reported symptoms."
        },
        "examFindings": {
            "type": "string",
            "description": "Physical examination findings."
        },
        "labResults": {
            "type": "string",
            "description": "Summary of recent lab results."
        },
        "diagnosis": {
          "type": "string",
          "description": "Diagnosis made during the consultation."
        },
        "prescriptionIds": {
          "type": "array",
          "description": "References to Prescriptions. (Relationship: Consultation 1:N Prescription)",
          "items": {
            "type": "string"
          }
        },
        "documents": {
          "type": "array",
          "description": "An array of documents associated with the consultation.",
          "items": {
            "$ref": "#/entities/Document"
          }
        }
      },
      "required": [
        "id",
        "patientId",
        "doctorId",
        "consultationDateTime",
        "notes",
        "diagnosis"
      ]
    },
    "Prescription": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Prescription",
      "type": "object",
      "description": "Represents a prescription issued during a consultation.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the prescription."
        },
        "consultationId": {
          "type": "string",
          "description": "Reference to the Consultation. (Relationship: Consultation 1:N Prescription)"
        },
        "drugName": {
          "type": "string",
          "description": "Name of the prescribed drug."
        },
        "dosage": {
          "type": "string",
          "description": "Dosage instructions for the drug."
        },
        "frequency": {
          "type": "string",
          "description": "Frequency of drug administration."
        },
        "notes": {
          "type": "string",
          "description": "Additional notes or instructions for the patient."
        }
      },
      "required": [
        "id",
        "consultationId",
        "drugName",
        "dosage",
        "frequency"
      ]
    },
    "Billing": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Billing",
      "type": "object",
      "description": "Represents a billing record for a patient's visit.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the billing record."
        },
        "patientId": {
          "type": "string",
          "description": "Reference to the Patient. (Relationship: Patient 1:N Billing)"
        },
        "consultationId": {
          "type": "string",
          "description": "Reference to the Consultation. (Relationship: Consultation 1:1 Billing)"
        },
        "billingDate": {
          "type": "string",
          "description": "Date of the billing.",
          "format": "date-time"
        },
        "amount": {
          "type": "number",
          "description": "Amount to be paid."
        },
        "paymentStatus": {
          "type": "string",
          "description": "Status of the payment (e.g., paid, unpaid, pending)."
        }
      },
      "required": [
        "id",
        "patientId",
        "consultationId",
        "billingDate",
        "amount",
        "paymentStatus"
      ]
    },
    "Document": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Document",
      "type": "object",
      "description": "Represents a document uploaded by a patient or doctor.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the document."
        },
        "patientId": {
          "type": "string",
          "description": "The ID of the patient to whom this document belongs."
        },
        "uploadedBy": {
          "type": "string",
          "description": "The UID of the user who uploaded the document."
        },
        "uploadDateTime": {
          "type": "string",
          "description": "Date and time when the document was uploaded.",
          "format": "date-time"
        },
        "fileName": {
            "type": "string",
            "description": "The original name of the uploaded file."
        },
        "fileType": {
          "type": "string",
          "description": "Type of the uploaded file (e.g., application/pdf, image/jpeg)."
        },
        "fileSize": {
          "type": "number",
          "description": "Size of the uploaded file in bytes."
        },
        "storagePath": {
          "type": "string",
          "description": "Path to the document stored in Firebase Storage."
        },
        "downloadURL": {
            "type": "string",
            "description": "Publicly accessible URL to download the document."
        },
        "tags": {
            "type": "array",
            "description": "AI-generated tags for the document.",
            "items": {
                "type": "string"
            }
        }
      },
      "required": [
        "id",
        "patientId",
        "uploadedBy",
        "uploadDateTime",
        "fileName",
        "fileType",
        "fileSize",
        "storagePath",
        "downloadURL"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system. (Authentication Data - NOT for passwords)",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "User's role (e.g., Admin, Doctor, Receptionist, Patient)."
        },
        "patientId": {
          "type": "string",
          "description": "Reference to the Patient entity if the user is a patient."
        },
        "doctorId": {
          "type": "string",
          "description": "Reference to the Doctor entity if the user is a doctor."
        },
        "verified": {
          "type": "boolean",
          "description": "Indicates if the user account (for doctors/receptionists) has been verified by an admin."
        }
      },
      "required": [
        "id",
        "email",
        "role"
      ]
    },
    "Conversation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Conversation",
      "type": "object",
      "description": "Represents a conversation between two or more users.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the conversation."
        },
        "participants": {
          "type": "array",
          "description": "An array of user UIDs who are part of the conversation.",
          "items": {
            "type": "string"
          }
        },
        "lastMessage": {
          "type": "string",
          "description": "The text of the last message sent in the conversation."
        },
        "lastMessageTimestamp": {
          "type": "string",
          "description": "Timestamp of the last message.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "participants"
      ]
    },
    "Message": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Message",
      "type": "object",
      "description": "Represents a single message within a conversation.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the message."
        },
        "conversationId": {
          "type": "string",
          "description": "The ID of the conversation this message belongs to."
        },
        "senderId": {
          "type": "string",
          "description": "The UID of the user who sent the message."
        },
        "text": {
          "type": "string",
          "description": "The content of the message."
        },
        "timestamp": {
          "type": "string",
          "description": "The time the message was sent.",
          "format": "date-time"
        },
        "imageUrl": {
            "type": "string",
            "description": "URL of an image attached to the message."
        },
        "fileUrl": {
            "type": "string",
            "description": "URL of a file attached to the message."
        },
        "fileName": {
            "type": "string",
            "description": "The name of the attached file."
        }
      },
      "required": [
        "id",
        "conversationId",
        "senderId",
        "timestamp"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous",
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user authentication data. The 'userId' parameter corresponds to the Firebase Auth UID. Contains user role information for authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            }
          ]
        }
      },
      {
        "path": "/patients/{patientId}",
        "definition": {
          "entityName": "Patient",
          "schema": {
            "$ref": "#/backend/entities/Patient"
          },
          "description": "Stores patient records. Accessible to receptionists, doctors, and the patient themselves.",
          "params": [
            {
              "name": "patientId",
              "description": "Unique identifier for the patient."
            }
          ]
        }
      },
      {
        "path": "/doctors/{doctorId}",
        "definition": {
          "entityName": "Doctor",
          "schema": {
            "$ref": "#/backend/entities/Doctor"
          },
          "description": "Stores doctor records. Accessible to administrators and receptionists.",
          "params": [
            {
              "name": "doctorId",
              "description": "Unique identifier for the doctor."
            }
          ]
        }
      },
      {
        "path": "/appointments/{appointmentId}",
        "definition": {
          "entityName": "Appointment",
          "schema": {
            "$ref": "#/backend/entities/Appointment"
          },
          "description": "Stores appointment records. Accessible to receptionists, doctors, and patients involved in the appointment.",
          "params": [
            {
              "name": "appointmentId",
              "description": "Unique identifier for the appointment."
            }
          ]
        }
      },
      {
        "path": "/consultations/{consultationId}",
        "definition": {
          "entityName": "Consultation",
          "schema": {
            "$ref": "#/backend/entities/Consultation"
          },
          "description": "Stores consultation records. Accessible to the doctor and patient involved in the consultation.",
          "params": [
            {
              "name": "consultationId",
              "description": "Unique identifier for the consultation."
            }
          ]
        }
      },
      {
        "path": "/prescriptions/{prescriptionId}",
        "definition": {
          "entityName": "Prescription",
          "schema": {
            "$ref": "#/backend/entities/Prescription"
          },
          "description": "Stores prescription records. Accessible to the doctor and patient associated with the prescription.",
          "params": [
            {
              "name": "prescriptionId",
              "description": "Unique identifier for the prescription."
            }
          ]
        }
      },
      {
        "path": "/billings/{billingId}",
        "definition": {
          "entityName": "Billing",
          "schema": {
            "$ref": "#/backend/entities/Billing"
          },
          "description": "Stores billing records. Accessible to receptionists and the patient associated with the billing record.",
          "params": [
            {
              "name": "billingId",
              "description": "Unique identifier for the billing record."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/documents/{documentId}",
        "definition": {
          "entityName": "Document",
          "schema": {
            "$ref": "#/backend/entities/Document"
          },
          "description": "Stores documents uploaded by patients or doctors. Accessible to the patient and authorized staff. The path is nested under the user (patient) to enforce security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user (patient)."
            },
            {
              "name": "documentId",
              "description": "Unique identifier for the document."
            }
          ]
        }
      },
      {
        "path": "/conversations/{conversationId}",
        "definition": {
          "entityName": "Conversation",
          "schema": {
            "$ref": "#/backend/entities/Conversation"
          },
          "description": "Stores conversation metadata. Accessible only to participants.",
          "params": [
            {
              "name": "conversationId",
              "description": "Unique identifier for the conversation."
            }
          ]
        }
      },
      {
        "path": "/conversations/{conversationId}/messages/{messageId}",
        "definition": {
          "entityName": "Message",
          "schema": {
            "$ref": "#/backend/entities/Message"
          },
          "description": "Stores messages within a conversation. Accessible only to participants of the parent conversation.",
          "params": [
            {
              "name": "conversationId",
              "description": "The ID of the parent conversation."
            },
            {
              "name": "messageId",
              "description": "Unique identifier for the message."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure security, scalability, and ease of debugging, following the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). Authorization Independence is achieved through denormalization of authorization data. Path-based ownership and membership maps are used for access control.\n\n**Explanation of Authorization Independence and QAPs:**\n\n*   **Authorization Independence:**\n    *   Ownership: Patient-owned data (documents) are stored under `/users/{userId}/documents/{documentId}`, ensuring that the security rules can directly verify the user's ID against the document's path without needing to `get()` parent document data. The `patientId` is denormalized into the `Document` to also allow listing all documents for a `patientId`.\n    *   Membership: Used for conversations. The `participants` array in each conversation document allows security rules to verify if a user is part of a conversation without needing extra lookups.\n*   **QAPs (Rules are not Filters):**\n    *   Structural Segregation: Data with different access requirements are stored in separate collections (e.g., `users`, `doctors`, `patients`).\n    *   Path-Based Ownership: Using `/users/{userId}/documents/{documentId}` ensures that listing documents requires knowing the `userId`, which can be checked against `request.auth.uid`."
  }
}
