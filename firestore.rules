
/**
 * @file Firebase Security Rules for Clinic Management System
 *
 * @corePhilosophy This ruleset enforces a strict user-ownership model for personal data,
 *   and role-based access for administrative data. It prioritizes security and
 *   simplicity for rapid prototyping and iteration, with minimal data validation.
 *
 * @dataStructure
 *   - /users/{userId}: Stores user authentication and role information. 'userId' must match the Firebase auth UID.
 *   - /patients/{patientId}: Stores patient records.
 *   - /doctors/{doctorId}: Stores doctor records.
 *   - /appointments/{appointmentId}: Stores appointment records.
 *   - /consultations/{consultationId}: Stores consultation records.
 *   - /prescriptions/{prescriptionId}: Stores prescription records.
 *   - /billings/{billingId}: Stores billing records.
 *   - /users/{userId}/documents/{documentId}: Stores documents uploaded by patients, nested under the user's ID.
 *
 * @keySecurityDecisions
 *   - User listing is disallowed for non-admins to protect privacy.
 *   - Data validation is minimized to focus on authorization during prototyping.
 *   - Helper functions like isDoctor() centralize role checks for maintainability.
 *
 * @denormalizationForAuthorization
 *   - User roles are stored in /users/{userId} and checked by other rules using get().
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for role-based access control
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    function isDoctor() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'doctor';
    }
    
    function isReceptionist() {
        return isSignedIn() && getUserRole(request.auth.uid) == 'receptionist';
    }

    function isPatient() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'patient';
    }

    /**
     * @description Secure access to user profiles. A user can read their own profile.
     * Admins can read any profile. Users can update their own profile.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin());
      allow list: if isAdmin();
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isAdmin(); // Admins can delete users
    }

    /**
     * @description Patients should be readable by doctors, receptionists, and admins.
     * Patients can read their own document.
     * @path /patients/{patientId}
     */
    match /patients/{patientId} {
      allow get: if (isPatient() && isOwner(patientId)) || isDoctor() || isReceptionist() || isAdmin();
      allow list: if isDoctor() || isReceptionist() || isAdmin();
      allow create, update, delete: if isAdmin() || isDoctor() || isReceptionist();
    }

    /**
     * @description Doctors list should be public to allow selection in forms.
     * @path /doctors/{doctorId}
     */
    match /doctors/{doctorId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Appointments are visible to relevant parties.
     * @path /appointments/{appointmentId}
     */
    match /appointments/{appointmentId} {
      allow get: if (isPatient() && resource.data.patientId == request.auth.uid) || isDoctor() || isReceptionist() || isAdmin();
      allow list: if isPatient() || isDoctor() || isReceptionist() || isAdmin();
      allow create, update, delete: if isDoctor() || isReceptionist() || isAdmin();
    }

    /**
     * @description Consultations are private between doctor and patient, but visible to admin.
     * @path /consultations/{consultationId}
     */
    match /consultations/{consultationId} {
      allow get: if (isPatient() && resource.data.patientId == request.auth.uid) || (isDoctor() && resource.data.doctorId == request.auth.uid) || isAdmin();
      allow list: if isDoctor() || isAdmin();
      allow create, update, delete: if isDoctor() || isAdmin();
    }

    /**
     * @description Prescriptions are private between doctor and patient, but visible to admin.
     * @path /prescriptions/{prescriptionId}
     */
    match /prescriptions/{prescriptionId} {
      allow get: if (isPatient() && get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.patientId == request.auth.uid) || isDoctor() || isAdmin();
      allow list: if isDoctor() || isAdmin();
      allow create, update, delete: if isDoctor() || isAdmin();
    }

    /**
     * @description Billing info accessible by receptionists, admins, and the specific patient.
     * @path /billings/{billingId}
     */
    match /billings/{billingId} {
      allow get: if (isPatient() && resource.data.patientId == request.auth.uid) || isReceptionist() || isAdmin();
      allow list: if isPatient() || isReceptionist() || isAdmin();
      allow create, update, delete: if isReceptionist() || isAdmin();
    }

    /**
     * @description Secure access to patient documents. Only the authenticated user (patient) can read or write their own documents.
     * @path /users/{userId}/documents/{documentId}
     */
    match /users/{userId}/documents/{documentId} {
      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
      }
      allow get, list: if isSignedIn() && isOwner(userId) || isAdmin();
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.patientId == userId || isAdmin();
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.patientId == resource.data.patientId || isAdmin();
      allow delete: if isSignedIn() && isExistingOwner(userId) || isAdmin();
    }
  }
}
