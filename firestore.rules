
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======== HELPER FUNCTIONS ========

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Function to get the requesting user's role document data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isUser(role) {
      return isSignedIn() && getUserData().role == role;
    }
    
    function isAdmin() {
      return isUser('admin');
    }

    function isDoctor() {
      return isUser('doctor');
    }

    function isReceptionist() {
      return isUser('receptionist');
    }

    function isPatient() {
      return isUser('patient');
    }

    // ======== COLLECTION RULES ========

    match /users/{userId} {
      // Allow users to read their own profile and admins to read any.
      allow get: if isOwner(userId) || isAdmin();
      // A user can create their own profile. An admin can create any.
      allow create: if isOwner(userId) || isAdmin();
      // A user can update their own profile. An admin can update any.
      allow update: if isOwner(userId) || isAdmin();
      // Only admins can see the full list of users.
      allow list: if isAdmin();
      // Allow admins to delete user documents.
      allow delete: if isAdmin();

      // Rules for the nested documents subcollection
      match /documents/{documentId} {
        // A user can read their own documents. Staff can read any document.
        allow get, list: if isOwner(userId) || isDoctor() || isReceptionist() || isAdmin();
        
        // Let any authenticated user create a document.
        // This is needed for patients to upload their own, and staff to upload on their behalf.
        allow create: if isSignedIn();

        // Only the owner, doctors, receptionists, or admins can update or delete.
        allow update, delete: if isOwner(userId) || isDoctor() || isReceptionist() || isAdmin();
      }
    }

    match /patients/{patientId} {
      // A patient can get their own record. Doctors, Receptionists, and Admins can get any patient record.
      allow get: if (isPatient() && isOwner(patientId)) || isDoctor() || isReceptionist() || isAdmin();
      // Allow staff to list all patients. The client-side query will handle filtering.
      allow list: if isDoctor() || isReceptionist() || isAdmin();
      // Patients can create their own record on signup. Staff can create new patients.
      allow create: if isOwner(patientId) || isReceptionist() || isAdmin();
      // Only staff can update patient records.
      allow update: if isReceptionist() || isDoctor() || isAdmin();
      // Only Admins can delete patient records.
      allow delete: if isAdmin();
    }

    match /doctors/{doctorId} {
        // Any authenticated user can view a doctor's profile.
        allow get, list: if isSignedIn();
        // A doctor can create their own record. Admins can create new doctors.
        allow create: if (isDoctor() && isOwner(doctorId)) || isAdmin();
        // Doctors can update their own profile. Admins can update any.
        allow update: if (isDoctor() && isOwner(doctorId)) || isAdmin();
        // Only Admins can delete doctor records.
        allow delete: if isAdmin();
    }

    match /appointments/{appointmentId} {
      // Involved parties (patient, doctor) and staff can view appointments.
      allow get: if isSignedIn() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        isReceptionist() ||
        isDoctor() ||
        isAdmin()
      );
      // Let any authenticated user attempt to list appointments.
      // The client query is responsible for correctly filtering (e.g., patient sees their own).
      allow list: if isSignedIn();
      // Any authenticated user can create appointments.
      allow create: if isSignedIn();
      // Only staff can update or delete appointments.
      allow update, delete: if isDoctor() || isReceptionist() || isAdmin();
    }

    match /consultations/{consultationId} {
      // Staff can list consultations.
      allow list: if isDoctor() || isReceptionist() || isAdmin();
      // The specific patient or doctor involved can get their own consultation, and staff can get any.
      allow get: if isSignedIn() && (
          resource.data.patientId == request.auth.uid ||
          resource.data.doctorId == request.auth.uid ||
          isDoctor() || isReceptionist() || isAdmin()
      );
      // Only doctors and admins can create, update or delete consultations.
      allow create, update, delete: if isDoctor() || isAdmin();
    }

    match /prescriptions/{prescriptionId} {
        // Let staff and involved patient/doctor read.
        allow get: if isSignedIn() && (isDoctor() || isReceptionist() || isAdmin() || get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.patientId == request.auth.uid);
        // Allow staff to list prescriptions.
        allow list: if isDoctor() || isReceptionist() || isAdmin();
        // Only doctors and admins can create/update/delete.
        allow create, update, delete: if isDoctor() || isAdmin();
    }

    match /billings/{billingId} {
        // Let receptionists, admins, and the specific patient read.
        allow get: if isSignedIn() && (isReceptionist() || isAdmin() || resource.data.patientId == request.auth.uid);
        // Let any authenticated user attempt to list their billings.
        // Client query is responsible for filtering to the current user.
        allow list: if isSignedIn();
        // Only receptionists and admins can manage billing.
        allow create, update, delete: if isReceptionist() || isAdmin();
    }

    match /conversations/{conversationId} {
      // A user can read a conversation document if they are a participant.
      allow get: if isSignedIn() && request.auth.uid in resource.data.participants;
      // A user can list conversations if their UID is in the 'participants' array.
      allow list: if isSignedIn() && request.auth.uid in query.filters.participants;

      // Allow creating a conversation if the user is one of the participants.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;

      // Allow updating (e.g. last message) if the user is a participant.
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;

      match /messages/{messageId} {
        // A user can read/list messages if they are part of the parent conversation.
        allow read, list: if isSignedIn() && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants.hasAny([request.auth.uid]);
        // A user can create a message if they are the sender and part of the conversation.
        allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants.hasAny([request.auth.uid]);
      }
    }

  }
}

    