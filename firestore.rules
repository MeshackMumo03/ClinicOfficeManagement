
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && getUserData().role == 'admin';
    }
    
    function isDoctor() {
        return isSignedIn() && getUserData().role == 'doctor';
    }

    function isReceptionist() {
        return isSignedIn() && getUserData().role == 'receptionist';
    }

    function isPatient() {
        return isSignedIn() && getUserData().role == 'patient';
    }

    // --- Collection Rules ---

    // USERS: User profile and role information.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // PATIENTS: Patient medical records.
    match /patients/{patientId} {
      allow get: if (isPatient() && isOwner(patientId)) || isDoctor() || isReceptionist() || isAdmin();
      allow list: if isDoctor() || isReceptionist() || isAdmin();
      allow create: if (isPatient() && isOwner(patientId)) || isReceptionist() || isAdmin();
      allow update: if isReceptionist() || isAdmin() || (isPatient() && isOwner(patientId));
      allow delete: if isAdmin();
    }

    // DOCTORS: Doctor information.
    match /doctors/{doctorId} {
      allow get: if isSignedIn();
      allow list: if isDoctor() || isReceptionist() || isAdmin();
      allow create: if isAdmin() || (isDoctor() && isOwner(doctorId));
      allow update, delete: if isAdmin();
    }

    // APPOINTMENTS: Scheduled appointments.
    match /appointments/{appointmentId} {
      allow read: if isSignedIn(); // Simplified for now, can be restricted later.
      allow list: if isSignedIn();
      allow create: if isDoctor() || isReceptionist() || isAdmin();
      allow update, delete: if isDoctor() || isReceptionist() || isAdmin();
    }

    // CONSULTATIONS: Consultation notes and details.
    match /consultations/{consultationId} {
      // Assuming consultation data contains patientId and doctorId
      allow read: if (isPatient() && isOwner(get(after).data.patientId)) || 
                     (isDoctor() && isOwner(get(after).data.doctorId)) ||
                     isAdmin();
      allow list: if isDoctor() || isAdmin();
      allow create: if isDoctor() || isAdmin();
      allow update, delete: if isDoctor() || isAdmin();
    }

    // PRESCRIPTIONS: Prescription details.
    match /prescriptions/{prescriptionId} {
      // Assuming prescription data links to a consultation
      allow read: if isSignedIn(); // Needs more specific rules based on consultation link
      allow create, update, delete: if isDoctor() || isAdmin();
    }

    // BILLINGS: Billing and invoice records.
    match /billings/{billingId} {
      allow read: if (isPatient() && isOwner(get(after).data.patientId)) ||
                     isReceptionist() || isAdmin();
      allow list: if isReceptionist() || isAdmin();
      allow create, update, delete: if isReceptionist() || isAdmin();
    }
    
    // DOCUMENTS: Patient-uploaded documents.
    match /users/{userId}/documents/{documentId} {
      allow read, write: if isOwner(userId);
    }
  }
}
