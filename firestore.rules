
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======== HELPER FUNCTIONS ========

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Function to get the requesting user's role document data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isUser(role) {
      return isSignedIn() && getUserData().role == role;
    }
    
    function isAdmin() {
      return isUser('admin');
    }

    function isDoctor() {
      return isUser('doctor');
    }

    function isReceptionist() {
      return isUser('receptionist');
    }

    function isPatient() {
      return isUser('patient');
    }

    // ======== COLLECTION RULES ========

    match /users/{userId} {
      // Allow users to read their own profile (for role checks) and admins to read any.
      allow get: if isOwner(userId) || isAdmin();
      // Users can create and update their own profile.
      allow create, update: if isOwner(userId);
      // Only admins can see the full list of users.
      allow list: if isAdmin();
      // Do not allow client-side deletes of user documents.
      allow delete: if false;
    }

    match /patients/{patientId} {
      // A patient can get their own record. Doctors, Receptionists, and Admins can get any patient record.
      allow get: if (isPatient() && isOwner(patientId)) || isDoctor() || isReceptionist() || isAdmin();
      // Doctors, Receptionists, and Admins can list all patients.
      allow list: if isDoctor() || isReceptionist() || isAdmin();
      // Patients can create their own record on signup. Staff can create new patients.
      allow create: if isOwner(patientId) || isReceptionist() || isAdmin();
      // Only staff can update patient records.
      allow update: if isReceptionist() || isDoctor() || isAdmin();
      // Only Admins can delete patient records.
      allow delete: if isAdmin();
    }

    match /doctors/{doctorId} {
        // Any authenticated user can view a doctor's profile.
        allow get, list: if isSignedIn();
        // A doctor can create their own record on signup. Admins can create new doctors.
        allow create: if (isDoctor() && isOwner(doctorId)) || isAdmin();
        // Doctors can update their own profile. Admins can update any.
        allow update: if (isDoctor() && isOwner(doctorId)) || isAdmin();
        // Only Admins can delete doctor records.
        allow delete: if isAdmin();
    }

    match /appointments/{appointmentId} {
      // Involved parties (patient, doctor) and staff can view appointments.
      allow get: if isSignedIn() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.doctorId == request.auth.uid ||
        isReceptionist() ||
        isDoctor() ||
        isAdmin()
      );
      // Staff roles can see all appointments. Patients can only list their own (which is handled by a client-side query).
      allow list: if exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (getUserData().role == 'doctor' || getUserData().role == 'receptionist' || getUserData().role == 'admin');
      // Patients, Doctors, Receptionists, and Admins can create appointments.
      allow create: if isSignedIn();
      // Only staff can update appointments.
      allow update, delete: if isDoctor() || isReceptionist() || isAdmin();
    }

    match /consultations/{consultationId} {
        // Let staff and involved patient/doctor read.
        allow get: if isSignedIn() && (isDoctor() || isReceptionist() || isAdmin() || resource.data.patientId == request.auth.uid);
        allow list: if isDoctor() || isReceptionist() || isAdmin();
        // Only doctors and admins can create/update/delete.
        allow create, update, delete: if isDoctor() || isAdmin();
    }

    match /prescriptions/{prescriptionId} {
        // Let staff and involved patient/doctor read.
        allow get: if isSignedIn() && (isDoctor() || isReceptionist() || isAdmin() || get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.patientId == request.auth.uid);
        allow list: if isDoctor() || isReceptionist() || isAdmin();
        // Only doctors and admins can create/update/delete.
        allow create, update, delete: if isDoctor() || isAdmin();
    }

    match /billings/{billingId} {
        // Let receptionists, admins, and the specific patient read.
        allow get: if isSignedIn() && (isReceptionist() || isAdmin() || resource.data.patientId == request.auth.uid);
        allow list: if exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (getUserData().role == 'receptionist' || getUserData().role == 'admin');
        // Only receptionists and admins can manage billing.
        allow create, update, delete: if isReceptionist() || isAdmin();
    }

    match /users/{userId}/documents/{documentId} {
      allow get, list, create, update, delete: if isOwner(userId);
    }
  }
}
