rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if the requesting user has the 'doctor' role.
    // It reads the user's document from the 'users' collection in Firestore.
    function isDoctor() {
      return get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'doctor';
    }

    // Allow uploads to any patient's document folder.
    match /documents/{patientId}/{allPaths=**} {
      // Allow read access if the user is the patient themselves OR if they are a doctor.
      allow read: if request.auth.uid == patientId || isDoctor();
      // Allow write access (uploads) if the user is the patient themselves OR if they are a doctor.
      allow write: if request.auth.uid == patientId || isDoctor();
    }
  }
}
